$ [ -d /opt/webenabled ] || { tar_f=/root/serverlink.tar ; [ ! -f $tar_f ] && exit 0; tar -xf $tar_f && ./serverlink/install/install.sh -Y ;} #=> --exit 0
$ [ -d /opt/webenabled ] || { i_f=/root/install.sh ; [ ! -f $i_f -a ! -x $i_f ] && exit 0 ; $i_f ;} #=> --exit 0
$ [ -d /opt/webenabled ] || { curl -sSL https://www.devpanel.com/install.sh | bash -s -- -3 ;} #=> --exit 0
$ hash devpanel
$ devpanel get server info | egrep -q '^Vhosts base domain: [^ ]+$' || devpanel init config --gen-hostname-from-ip #=> --exit 0

$ fuser -v http/tcp                                 #=> --exit 0
$ fuser -v smtp/tcp                                 #=> --exit 0
$ fuser -v ssh/tcp                                  #=> --exit 0
$ pidof cron || pidof crond                         #=> --exit 0

$ devpanel get server info                          #=> --exit 0
$ devpanel get server info                          #=> --egrep ^Linux Distribution: [^ ].+$
$ devpanel get server info                          #=> --egrep ^Vhosts base domain: [^ ]+$
$ devpanel get server info                          #=> --egrep ^Apache HTTP  Port: [1-9][0-9]*$
$ devpanel get server info                          #=> --egrep ^Apache HTTPS Port: [1-9][0-9]*$
$ devpanel get server info                          #=> --egrep ^HTTP to HTTPS redir: [^ ].+$
$ devpanel get server info                          #=> --egrep ^Number of vhosts: [0-9]+$
# broken. FIX ME! $ devpanel get server info                          #=> --egrep ^Distro Updates: (en|dis)?abled$
$ devpanel get server info                          #=> --egrep ^Long vhost names: (en|dis)?abled$
$ devpanel get server info                          #=> --egrep ^PHP Version: [5-7].[0-9]$
$ devpanel get server info                          #=> --egrep ^Platform Version: [1-3]$

$ devpanel dump metadata                            #=> --exit 0
$ devpanel dump metadata | fgrep null               #=> --exit 1
$ devpanel list apps                                #=> --exit 0


##########
#
#########
$ devpanel install app --vhost d7-test-one --app drupal-v7 #=> --exit 0
$ devpanel test http --vhost d7-test-one                   #=> --exit 0
$ devpanel status mysql --vhost d7-test-one                #=> --exit 0
$ devpanel clear app cache --vhost d7-test-one             #=> --exit 0
$ devpanel config app --admin-password $(head -c 1024 /dev/urandom | tr -dc A-Za-z0-9_ | cut -b 1-10) --vhost d7-test-one #=> --exit 0
$ devpanel refresh config --vhost d7-test-one              #=> --exit 0
$ devpanel repair mysql database --vhost d7-test-one       #=> --exit 0
$ devpanel cat vhost config --vhost d7-test-one            #=> --exit 0

$ devpanel add domain --vhost d7-test-one --domain my-first-domain.com --domain www.my-first-domain.com   #=> --exit 0
$ fgrep 'my-first-domain.com www.my-first-domain.com' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini    #=> --exit 0
$ devpanel remove domain --vhost d7-test-one --domain www.my-first-domain.com                             #=> --exit 0
$ fgrep 'www.my-first-domain.com' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini                        #=> --exit 1
$ devpanel find domain --domain my-first-domain.com                                                       #=> --exit 0
$ devpanel remove domain --vhost d7-test-one --domain my-first-domain.com  #=> --exit 0

# Temporarily disabled these tests because the dbmgr start script hangs when
# running in background
#
#$ devpanel stop   mysql --vhost d7-test-one                #=> --exit 0
#$ devpanel start mysql --vhost d7-test-one < /dev/null     #=> --exit 0
#$ sleep 2; devpanel status mysql --vhost d7-test-one       #=> --exit 0

$ devpanel enable htpasswd --vhost d7-test-one                          #=> --exit 0
$ fgrep 'htpasswd=yes' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini #=> --exit 0
$ devpanel test http --vhost d7-test-one --http-code 401                #=> --exit 0
$ echo test_pw | devpanel manage htpasswd --add-user test --vhost d7-test-one #=> --exit 0
$ devpanel test http --vhost d7-test-one --http-user-pass test:test_pw   #=> --exit 0
$ devpanel disable htpasswd --vhost d7-test-one            #=> --exit 0
$ fgrep 'htpasswd=yes' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini #=> --exit 1

$ devpanel enable fastcgi --vhost d7-test-one              #=> --exit 0
$ fgrep 'fastcgi=yes' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini #=> --exit 0
$ devpanel test http --vhost d7-test-one                   #=> --exit 0
$ devpanel disable fastcgi --vhost d7-test-one             #=> --exit 0
$ fgrep 'fastcgi=yes' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini #=> --exit 1
$ devpanel test http --vhost d7-test-one                   #=> --exit 0

$ devpanel backup vhost --vhost d7-test-one                #=> --exit 0
$ devpanel list backups --vhost d7-test-one                #=> --exit 0
$ devpanel disable vhost --vhost d7-test-one               #=> --exit 0
$ fgrep 'enabled=no' /etc/devpanel/lamp/vhosts/d7-test-one/config.ini #=> --exit 0
$ devpanel test http --vhost d7-test-one --uri /index.php --http-code 404  #=> --exit 0
$ devpanel enable vhost --vhost d7-test-one                #=> --exit 0
$ devpanel test http --vhost d7-test-one --uri /index.php  #=> --exit 0
$ devpanel test http --vhost d7-test-one                   #=> --exit 0

$ devpanel get token --vhost d7-test-one --tool phpmyadmin  #=> --exit 0

$ devpanel rewrite vhost config --vhost d7-test-one        #=> --exit 0

$ : Testing vhost specific PHP version
$ devpanel set php version --vhost d7-test-one --version 7.1    #=> --exit 0
$ devpanel exec --vhost d7-test-one php -v                      #=> --egrep ^PHP 7.1.[0-9]+
$ devpanel show vhost info  --vhost d7-test-one                 #=> --egrep ^PHP Version: 7.1
$ devpanel set php version --vhost d7-test-one --version 5.6    #=> --exit 0
$ devpanel exec --vhost d7-test-one php -v                      #=> --egrep ^PHP 5.6.[0-9]+
$ devpanel show vhost info  --vhost d7-test-one                 #=> --egrep ^PHP Version: 5.6
$ :  #=> --exit 0

$ devpanel clone vhost --source-vhost d7-test-one --target-vhost d7-test-two   #=> --exit 0
$ : #=> --exit 0

$ : Testing global PHP version
$ devpanel create vhost --from we://blank --vhost blk1 #=> --exit 0
$ devpanel set default php --version 7.1                       #=> --exit 0
$ devpanel exec --vhost blk1 php -v                            #=> --egrep ^PHP 7.1.[0-9]+
$ devpanel show vhost info --vhost blk1                        #=> --egrep ^PHP Version: 7.1
$ : #=> --exit 0

$ : ssh keys
$ : ssh_add ; kf=$(mktemp) && rm -f $kf && trap 'rm -f $kf' EXIT && ssh-keygen -f $kf -t rsa -b 4096 -P '' && devpanel add ssh key --vhost d7-test-one --file $kf.pub #=> --exit 0
$ : ssh_add ; kf=$(mktemp) && rm -f $kf && trap 'rm -f $kf' EXIT && ssh-keygen -f $kf -t rsa -b 4096 -P '' && devpanel add ssh key --vhost d7-test-one --file $kf.pub #=> --exit 0
$ devpanel exec --vhost d7-test-one wc -l \< .ssh/authorized_keys #=> 2
$ : ssh_rm  ; kf=$(mktemp) && rm -f $kf && trap 'rm -f $kf' EXIT && ssh-keygen -f $kf -t rsa -b 4096 -P '' && devpanel add ssh key --vhost d7-test-one --file $kf.pub && devpanel remove ssh key --vhost d7-test-one --file $kf.pub #=> --exit 0
$ : #=> --exit 0

$ devpanel install app  --vhost wp-four-test-one --app wordpress-v4 #=> --exit 0
$ devpanel status mysql --vhost wp-four-test-one                   #=> --exit 0
$ devpanel test http --vhost wp-four-test-one                      #=> --exit 0
#$ devpanel stop   mysql --vhost wp-four-test-one                   #=> --exit 0
#$ devpanel start  mysql --vhost wp-four-test-one                   #=> --exit 0
#$ devpanel status mysql --vhost wp-four-test-one                   #=> --exit 0

$ devpanel install app  --vhost grav1 --app grav-v1  #=> --exit 0
$ devpanel status mysql --vhost grav1                #=> --exit 0
$ devpanel test http --vhost grav1                   #=> --exit 0

#$ devpanel stop   mysql --vhost grav1               #=> --exit 0
#$ devpanel start  mysql --vhost grav1               #=> --exit 0
#$ devpanel status mysql --vhost grav1               #=> --exit 0

$ devpanel enable long vhost names --yes                                 #=> --exit 0
$ devpanel get server info | egrep -x 'Long vhost names: enabled'        #=> --exit 0

$ devpanel enable distro updates   --yes                                        #=> --exit 0
$ devpanel get server info               | egrep -x 'Distro Updates: enabled'   #=> --exit 0
$ devpanel disable distro updates  --yes                                        #=> --exit 0
$ devpanel get server info               | egrep -x 'Distro Updates: disabled'  #=> --exit 0

$ devpanel enable webenabled compat --yes                                #=> --exit 0
$ devpanel get server info | egrep -x 'Webenabled v1 Compatibility: yes' #=> --exit 0

$ devpanel disable webenabled compat --yes                        #=> --exit 0
$ devpanel get server info | egrep 'Webenabled v1 Compatibility:' #=> --exit 1
