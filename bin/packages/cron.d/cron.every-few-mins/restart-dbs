#!/bin/bash

cleanup() {
  unlock
}

unlock() {
  if [ -n "$locked" -a -L "$lock_file" ]; then
    rm -f "$lock_file"
  fi
}

# main

self_bin=`readlink -e "$0"`
if [ $? -ne 0 ]; then
  echo "Error: unable to get self path" 1>&2
  exit 1
fi

self_dir="${self_bin%/*}"
sys_dir="${self_dir%/*/*/*/*}"

#lib_f="$sys_dir/lib/functions.linux-kernel.sh"
lib_f="$sys_dir/lib/functions"
if ! source "$lib_f"; then
  echo "Error: unable to import $lib_f" 1>&2
  exit 1
fi

unset locked
trap cleanup EXIT
lock_dir=$(get_system_lock_dir 2>/dev/null) || "$sys_dir/sbin/create-base-dirs"
lock_file="$lock_dir/${0##*/}"

if ln -s $BASHPID "$lock_file" 2>/dev/null; then
  locked=1
else
  if [ -t 0 ]; then
    echo "Warning: there's another instance running. Exiting." 1>&2
  fi
  exit 0
fi

for vhost in $(get_list_of_enabled_vhosts); do
  if has_a_safe_level_of_free_ram; then
    # if the database was not manually stopped by the user, then start it
    devpanel start mysql --vhost "$vhost" --conditional
  else
    # not enough free ram, the server might be in a high memory pressure.
    # Just stop trying to start databases
    break
  fi
done

exit 0
