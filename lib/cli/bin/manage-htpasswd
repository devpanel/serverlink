#!/bin/bash

set_usage_msg \
  "Usage: $bin_name ${cmd_ar[*]} [opts] --vhost <vhost>

  Options:
    --vhost     <vhost>         the vhost to protect
    --add-user  <username>      add the specified user
    --del-user  <username>      delete the specified user
    --chpasswd  <username>      changes the password of the specified user

  Of the options to add, remove and change password, only one can be used at
  a time.

  Manage htpasswd users.
"

devpanel_cmd__manage_htpasswd() {
  [ $EUID -eq 0 ] && [ $# -eq 0 -o -z "$1" ] && usage

  local name vhost file password
  local op op_str user htpasswd_file
  local -a cmd_args=()

  local -i exclusive_ops=0

  while [ -n "$1" ]; do
    name="$1"
    case "$name" in
      --vhost)
        [ -z "$2" ] && error_missing_value vhost
        vhost="$2"
        shift 2
        ;;
      --add-user|--del-user|--chpasswd)
        [ -z "$2" ] && error_missing_value ${name#--}
        exclusive_ops+=1
        username="$2"
        op=${name#--}
        shift 2
        ;;

      --help)
        usage
        ;;
      --[A-Za-z0-9_-]*)
        error "unknown option $name"
        ;;
      *)
        cmd_args+=( "$name" )
        shift
        ;;
    esac
  done

  if [ $EUID -eq 0 ]; then
    [ -z "$vhost" ] && error_missing_param vhost

    if ! vhost_exists "$vhost"; then
      error "vhost doesn't exist."
    fi
  else
    if ! vhost=$(get_vhost_from_linuxuser); then
      error "unable to determine vhost for current user"
    fi
  fi

  load_vhost_config "$vhost" || return $?
  user="$v__vhost__linux_user"

  if [ $exclusive_ops -gt 1 ]; then
    error "only one of --add-user, --del-user, --chpasswd can be used a time"
  fi

  if [ -z "$op" ]; then
    local errmsg
    errmsg="no option choosen. "
    errmsg="One of --add-user, --del-user or --chpasswd needs to be specified"
    error "$errmsg"
  fi

  [ -z "$username" ] && error_missing_param username

  local has_tty

  if [ -t 0 ]; then
    has_tty=1
  fi

  if [ "$op" == "add-user" -o "$op" == "chpasswd" ]; then
    while [ -z "$password" ]; do
      read ${has_tty:+-s} -p "Password: " password
    done
    echo # for the next line to start after the Password:
  fi

  case $op in
    add-user)
      op_str="+:$username:$password"
      ;;
    del-user)
      op_str="-:$username"
      ;;
    chpasswd)
      op_str="=:$username:$password"
      ;;
    *)
      error "unknown op"
      ;;
  esac

  local exec_bin="$sys_dir/bin/htpasswd-bulk"

  htpasswd_file="$v__vhost__linux_user_home/.htpasswd"
  cmd_args=( "$exec_bin" -c "$htpasswd_file" )
  if [ $EUID -eq 0 ]; then
    echo "$op_str" | su -l -c "${cmd_args[*]}" "$user"
  else
    echo "$op_str" | "${cmd_args[@]}"
  fi

}
